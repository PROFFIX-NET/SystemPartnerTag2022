<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geocoder</title>
  <style type="text/css">
    .hide {
      display: none;
    }

    #error {
      color: red;
    }

    #noUpdateNeeded,
    #updateCompleted {
      color: darkgreen;
    }

  </style>
</head>

<body>

  <div id="loading">
    Bitte warten...
  </div>

  <div id="noUpdateNeeded" class="hide">
    Keine Aktualisierung der Koordinaten erforderlich
  </div>

  <div id="updateNeeded" class="hide">
    Sollen die Koordinaten aktualisiert werden?<br>
    <button type="button" id="btnUpdate">Aktualisieren</button>
  </div>

  <div id="updateCompleted" class="hide">
    Die Koordinaten wurden aktualisiert, bitte Adresse ohne zu speichern neu laden.
  </div>

  <div id="error" class="hide">
    <div id="errorMsg"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBkdHIDYcjyIWWetyNLpevJpl573T4s9ys" defer></script>
  <script>
    $(document).ready(function () {
      var coordsFromApi = { lat: null, lng: null };

      // URL Params from Proffix
      const urlParams = new URLSearchParams(window.location.search);
      const pxAdressCoords = {
        lat: parseFloat(urlParams.get("latitude")),
        lng: parseFloat(urlParams.get("longitude"))
      };
      const pxAddressNo = urlParams.get("adressnr");
      const pxAddressSearchString = urlParams.get("adresssuche");
      const pxRestApiUrl = urlParams.get("restapiurl");
      const pxLoginObj = {
        Benutzer: null, // no user for login with token
        Passwort: urlParams.get("logintoken"),
        Datenbank: { Name: urlParams.get("dbname") },
        Module: ["VOL"]
      }

      // Events
      $("#btnUpdate").click(function () {
        updateCoodinates(pxRestApiUrl, pxLoginObj, pxAddressNo, coordsFromApi);
      });

      // Check if update needed,
      // use Google Maps API Geocoder store the result in variable 'coordsFromApi'
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ 'address': pxAddressSearchString }, function (results, status) {
        if (status == 'OK' && results.length && results.length > 0) {
          coordsFromApi = {
            lat: results[0].geometry.location.lat().toFixed(6), // limit precision for fixed value
            lng: results[0].geometry.location.lng().toFixed(6)
          }

          // Set view state 'noUpdateNeeded' or 'updateNeeded'
          if (coordsFromApi.lat == pxAdressCoords.lat && coordsFromApi.lng == pxAdressCoords.lng) {
            setViewState("noUpdateNeeded");
          } else {
            setViewState("updateNeeded");
          }
        } else {

          // Use view state 'error' for errorhandling
          setErrorViewState("Beim Abrufen der Koordinaten ist folgender Fehler aufgetreten: " + status);
        }
      });

    });

    /**
     * Set the state of the view
     * use setErrorViewState() for set errors
     * 
     * @param {"loading" | "noUpdateNeeded" | "updateNeeded" | "updateCompleted" | "error"} viewState
     */
    function setViewState(viewState) {
      $("#loading, #noUpdateNeeded, #updateNeeded, #updateCompleted, #error").addClass("hide");
      $("#" + viewState).removeClass("hide");
    }

    /**
     * Set the error state with message
     * 
     * @param {string} errorMsg
     */
    function setErrorViewState(errorMsg) {
      setViewState("error");
      $("#errorMsg").text(errorMsg);
    }

    /**
     * Update the coordinates for an address in Proffix
     * 
     * @param {string} pxRestApiUrl
     * @param {{Benutzer: null, Passwort: string, Datenbank: { Name: string }, Module: string[]}} pxLoginObj
     * @param {string} pxAddressNo
     * @param {{lat: number, lng: number}} coordsFromApi
     */
    function updateCoodinates(pxRestApiUrl, pxLoginObj, pxAddressNo, coordsFromApi) {
      setViewState("loading");

      // Login on Proffix REST API,
      // use view state 'error' for errorhandling
      $.ajax({
        url: pxRestApiUrl + "/pxapi/v4/PRO/Login",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(pxLoginObj),
        error: function (response) {
          setErrorViewState("REST API Loginfehler: " + JSON.stringify(response))
        },
        success: function (response, status, xhr) {
          var sessionId = xhr.getResponseHeader("pxsessionid"); // save PxSessionId for next API call

          // Patch address with new coordinates,
          // set view state 'updateCompleted' on success
          // use view state 'error' for errorhandling
          $.ajax({
            url: pxRestApiUrl + "/pxapi/v4/ADR/Adresse/" + pxAddressNo,
            type: "PATCH",
            contentType: "application/json",
            headers: { PxSessionId: sessionId },
            data: JSON.stringify({
              AdressNr: pxAddressNo,
              Latitude: coordsFromApi.lat,
              Longitude: coordsFromApi.lng
            }),
            error: function (response) {
              setErrorViewState("REST API Aktualisierungsfehler: " + JSON.stringify(response));
            },
            success: function () {
              setViewState("updateCompleted");
            }
          });
        }
      })
    }

  </script>
</body>

</html>
